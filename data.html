<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Data Coverage · BVB Index Distribution</title>
    <link rel="stylesheet" href="styles.css" />
</head>
<body>

<div class="top-nav">
    <div class="top-nav-inner">
        <div class="top-nav-title">BVB Index Distribution</div>
        <div class="top-nav-tabs">
            <a class="top-nav-tab" href="index.html">Tracker</a>
            <a class="top-nav-tab" href="about.html">About</a>
            <a class="top-nav-tab active" href="data.html">Data Coverage</a>
        </div>
    </div>
</div>

<div class="container page-content">
    <h2>Data Coverage</h2>

    <div class="card">
        <p class="muted">
            This page lists all daily BET snapshot files (<code>bvb-companies-YYYY-MM-DD.csv</code>) and highlights missing days.
            It reads the repository folder: <code>input/bvb_distribution</code>.
        </p>
        <div class="muted">Status: <span id="status">Loading…</span></div>
    </div>

    <!-- Static meta sources -->
    <div class="card">
        <h3 style="margin-top:0;">Static meta (manual snapshot)</h3>

        <div class="summary-grid">
            <div>
                <div class="muted">EUR/RON (fixed)</div>
                <div id="eurRonValue" class="summary-value">—</div>
                <div class="muted" style="margin-top:6px;">Updated at</div>
                <div id="eurRonUpdated" class="summary-value" style="font-size:14px;">—</div>
                <div class="muted" style="margin-top:10px;">
                    <a id="eurRonDownload" href="#" download>Download JSON</a>
                </div>
            </div>

            <div>
                <div class="muted">Tradeville fees (BVB)</div>
                <div id="tvFeesStatus" class="summary-value">—</div>
                <div class="muted" style="margin-top:6px;">Updated at</div>
                <div id="tvFeesUpdated" class="summary-value" style="font-size:14px;">—</div>
                <div class="muted" style="margin-top:10px;">
                    <a id="tvFeesDownload" href="#" download>Download JSON</a>
                </div>
            </div>
        </div>

        <div class="muted" style="margin-top:12px;">
            These values are stored in <code>input/meta</code> and are not updated automatically.
        </div>

        <div id="tvFeesPreview" style="margin-top:14px;"></div>
    </div>

    <!-- Index data status -->
    <div class="card">
        <h3 style="margin-top:0;">Index data status</h3>
        <div class="summary-grid">
            <div>
                <div class="muted">Last snapshot</div>
                <div id="statusLastDate" class="summary-value">—</div>
            </div>
            <div>
                <div class="muted">Coverage status</div>
                <div id="coverageStatus" class="summary-value">—</div>
            </div>
        </div>
    </div>

    <!-- Calendar -->
    <div class="card">
        <h3 style="margin-top:0;">Coverage calendar</h3>
        <div id="calendar" class="coverage-calendar"></div>

        <div class="coverage-legend">
            <div class="coverage-legend-item">
                <span class="coverage-box" style="background:#2ea043;border-color:#2ea043;"></span>
                <span class="muted">present</span>
            </div>
            <div class="coverage-legend-item">
                <span class="coverage-box" style="background:#d73a49;border-color:#d73a49;"></span>
                <span class="muted">missing (past day, tracked)</span>
            </div>
            <div class="coverage-legend-item">
                <span class="coverage-box" style="background:#d0d7de;border-color:#d0d7de;"></span>
                <span class="muted">not tracked yet / future</span>
            </div>
        </div>
    </div>

    <!-- Summary -->
    <div class="card">
        <h3 style="margin-top:0;">Summary</h3>
        <div class="summary-grid">
            <div><div class="muted">First date</div><div id="firstDate" class="summary-value">—</div></div>
            <div><div class="muted">Last date</div><div id="lastDate" class="summary-value">—</div></div>
            <div><div class="muted">Days present</div><div id="presentCount" class="summary-value">—</div></div>
            <div><div class="muted">Missing days</div><div id="missingCount" class="summary-value">—</div></div>
        </div>
    </div>

    <!-- Missing days -->
    <div class="card">
        <h3 style="margin-top:0;">Missing days</h3>
        <div id="missingDays" class="muted">—</div>
    </div>

    <!-- Files -->
    <div class="card">
        <h3 style="margin-top:0;">All snapshots</h3>
        <div id="fileList" class="file-list muted">—</div>
    </div>
</div>

<script>
    const OWNER = "DragosGeornoiu";
    const REPO = "bvb-index-distribution";
    const FOLDER_PATH = "input/bvb_distribution";
    const FILE_REGEX = /^bvb-companies-(\d{4})-(\d{2})-(\d{2})\.csv$/;

    const statusEl = document.getElementById("status");
    const calendarEl = document.getElementById("calendar");
    const fileListEl = document.getElementById("fileList");
    const missingDaysEl = document.getElementById("missingDays");

    const firstDateEl = document.getElementById("firstDate");
    const lastDateEl = document.getElementById("lastDate");
    const presentCountEl = document.getElementById("presentCount");
    const missingCountEl = document.getElementById("missingCount");

    const statusLastDateEl = document.getElementById("statusLastDate");
    const coverageStatusEl = document.getElementById("coverageStatus");

    const eurRonValueEl = document.getElementById("eurRonValue");
    const eurRonUpdatedEl = document.getElementById("eurRonUpdated");
    const eurRonDownloadEl = document.getElementById("eurRonDownload");

    const tvFeesStatusEl = document.getElementById("tvFeesStatus");
    const tvFeesUpdatedEl = document.getElementById("tvFeesUpdated");
    const tvFeesDownloadEl = document.getElementById("tvFeesDownload");
    const tvFeesPreviewEl = document.getElementById("tvFeesPreview");

    // --------- UTC-safe date helpers (avoid timezone shifting) ---------
    function pad2(n) { return String(n).padStart(2, "0"); }

    function isoDateUTC(d) {
        return `${d.getUTCFullYear()}-${pad2(d.getUTCMonth() + 1)}-${pad2(d.getUTCDate())}`;
    }

    function parseISODateUTC(s) {
        const [y, m, d] = s.split("-").map(Number);
        return new Date(Date.UTC(y, m - 1, d));
    }

    function addDaysUTC(d, n) {
        const x = new Date(d);
        x.setUTCDate(x.getUTCDate() + n);
        return x;
    }

    function utcMidnightNow() {
        const now = new Date();
        return new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
    }

    function startOfWeekMondayUTC(d) {
        const x = new Date(d);
        const day = (x.getUTCDay() + 6) % 7; // Mon=0
        return addDaysUTC(x, -day);
    }

    function firstOfMonthUTC(d) {
        return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), 1));
    }

    function endOfMonthUTC(d) {
        return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth() + 1, 0));
    }

    function monthShortName(m) {
        return ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][m];
    }

    function daysBetweenUTC(a, b) {
        const ms = 24 * 60 * 60 * 1000;
        return Math.floor((b - a) / ms);
    }
    // ------------------------------------------------------------------

    async function loadFolderListing() {
        const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FOLDER_PATH}`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error(`GitHub API error: ${resp.status}`);
        return await resp.json();
    }

    function extractDates(files) {
        const dates = [];
        const fileByDate = new Map();
        for (const f of files) {
            const m = f.name.match(FILE_REGEX);
            if (!m) continue;
            const dateStr = `${m[1]}-${m[2]}-${m[3]}`;
            dates.push(dateStr);
            fileByDate.set(dateStr, f.html_url);
        }
        dates.sort();
        return { dates, fileByDate };
    }

    function computeMissing(dates) {
        if (dates.length === 0) return [];

        const present = new Set(dates);
        const first = parseISODateUTC(dates[0]);
        const today = utcMidnightNow();

        const missing = [];
        for (let d = new Date(first); d < today; d = addDaysUTC(d, 1)) {
            const key = isoDateUTC(d);
            if (!present.has(key)) missing.push(key);
        }
        return missing;
    }

    function renderCoverageStatus(dates, missing) {
        if (dates.length === 0) {
            coverageStatusEl.textContent = "No data available";
            coverageStatusEl.style.color = "#d73a49";
            return;
        }

        const last = parseISODateUTC(dates[dates.length - 1]);
        const today = utcMidnightNow();
        const daysSinceLast = daysBetweenUTC(last, today);

        if (missing.length > 0) {
            coverageStatusEl.textContent = "Missing past days detected";
            coverageStatusEl.style.color = "#d73a49";
        } else if (daysSinceLast > 1) {
            coverageStatusEl.textContent = "Index data not updated recently";
            coverageStatusEl.style.color = "#d29922";
        } else {
            coverageStatusEl.textContent = "All expected days are covered";
            coverageStatusEl.style.color = "#2ea043";
        }
    }

    function renderCalendar(dates) {
        calendarEl.innerHTML = "";
        if (dates.length === 0) return;

        const present = new Set(dates);
        const firstSnapshot = parseISODateUTC(dates[0]);
        const today = utcMidnightNow();

        const startMonth = firstOfMonthUTC(firstSnapshot);
        const endMonth = endOfMonthUTC(today);

        const gridStart = startOfWeekMondayUTC(startMonth);
        const gridEnd = addDaysUTC(startOfWeekMondayUTC(endMonth), 6);

        const weeks = [];
        for (let d = new Date(gridStart); d <= gridEnd; d = addDaysUTC(d, 7)) weeks.push(new Date(d));

        const grid = document.createElement("div");
        grid.className = "coverage-grid";
        const columns = document.createElement("div");
        columns.className = "coverage-columns";

        let lastMonth = null;

        for (const wStart of weeks) {
            const col = document.createElement("div");
            col.className = "coverage-week";

            const month = wStart.getUTCMonth();
            const monthEl = document.createElement("div");
            monthEl.className = "coverage-month";
            monthEl.textContent = (month !== lastMonth) ? monthShortName(month) : "\u00A0";
            lastMonth = month;
            col.appendChild(monthEl);

            for (let i = 0; i < 7; i++) {
                const day = addDaysUTC(wStart, i);
                const key = isoDateUTC(day);
                const cell = document.createElement("div");

                if (day < firstSnapshot) cell.className = "coverage-cell level-future";
                else if (present.has(key)) cell.className = "coverage-cell level-present";
                else if (day < today) cell.className = "coverage-cell level-missing";
                else cell.className = "coverage-cell level-future";

                cell.title = key;
                col.appendChild(cell);
            }

            columns.appendChild(col);
        }

        grid.appendChild(columns);
        calendarEl.appendChild(grid);
    }

    function renderFileList(dates, fileByDate) {
        fileListEl.innerHTML = dates.slice().reverse().map(d =>
            `<div>• <a href="${fileByDate.get(d)}" target="_blank" rel="noopener noreferrer">${d}</a></div>`
        ).join("");
    }

    function renderMissing(missing) {
        if (!missing.length) {
            missingDaysEl.innerHTML = `<span style="color:#2ea043;font-weight:600;">No missing days detected ✅</span>`;
            return;
        }
        missingDaysEl.innerHTML = missing.map(d => `<div>${d}</div>`).join("");
    }

    async function loadMetaJson(path) {
        const resp = await fetch(path, { cache: "no-store" });
        if (!resp.ok) throw new Error(`Failed to load ${path}: ${resp.status}`);
        return await resp.json();
    }

    function renderFeesPreview(fees) {
        if (!fees || !Array.isArray(fees.tiers)) {
            tvFeesPreviewEl.innerHTML = `<div class="muted">No fee details available.</div>`;
            return;
        }

        const rows = fees.tiers.map(t => {
            const thr = (t.threshold_eur_min === null || t.threshold_eur_min === undefined)
                ? "—"
                : `${Number(t.threshold_eur_min).toLocaleString()} EUR+`;

            const main = `${t.fee_percent.toFixed(2)}% + €${t.fixed_fee_eur.toFixed(2)}`;
            const intra = `${t.intraday_fee_percent.toFixed(2)}% + €${t.intraday_fixed_fee_eur.toFixed(2)}`;

            return `<tr>
                <td style="font-weight:600;">${t.name}</td>
                <td>${thr}</td>
                <td>${main}</td>
                <td>${intra}</td>
            </tr>`;
        }).join("");

        tvFeesPreviewEl.innerHTML = `
            <table>
                <thead>
                    <tr>
                        <th>Tier</th>
                        <th>Threshold</th>
                        <th>BVB fee</th>
                        <th>Intra-day fee</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
        `;
    }

    async function initMeta() {
        eurRonDownloadEl.href = "input/meta/eur_ron.json";
        tvFeesDownloadEl.href = "input/meta/tradeville_fees_ro_bvb.json";

        try {
            const eur = await loadMetaJson("input/meta/eur_ron.json");
            eurRonValueEl.textContent = (typeof eur.eur_ron === "number") ? eur.eur_ron.toFixed(4) : "—";
            eurRonUpdatedEl.textContent = eur.updated_at_utc || "—";
        } catch {
            eurRonValueEl.textContent = "—";
            eurRonUpdatedEl.textContent = "—";
        }

        try {
            const fees = await loadMetaJson("input/meta/tradeville_fees_ro_bvb.json");
            tvFeesStatusEl.textContent = "Loaded ✅";
            tvFeesStatusEl.style.color = "#2ea043";
            tvFeesUpdatedEl.textContent = fees.updated_at_utc || "—";
            renderFeesPreview(fees);
        } catch {
            tvFeesStatusEl.textContent = "Unavailable";
            tvFeesStatusEl.style.color = "#d73a49";
            tvFeesUpdatedEl.textContent = "—";
        }
    }

    (async function init() {
        try {
            statusEl.textContent = "Loading…";

            await initMeta();

            const files = await loadFolderListing();
            const { dates, fileByDate } = extractDates(files);

            const missing = computeMissing(dates);

            statusEl.textContent = "Loaded ✅";

            firstDateEl.textContent = dates[0] || "—";
            lastDateEl.textContent = dates[dates.length - 1] || "—";
            presentCountEl.textContent = dates.length;
            missingCountEl.textContent = missing.length;

            statusLastDateEl.textContent = dates[dates.length - 1] || "—";
            renderCoverageStatus(dates, missing);
            renderCalendar(dates);
            renderMissing(missing);
            renderFileList(dates, fileByDate);
        } catch (e) {
            console.error(e);
            statusEl.textContent = "Failed ❌";
        }
    })();
</script>

</body>
</html>
